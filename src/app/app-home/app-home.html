<div class="layout">
  <!-- Top header -->
  <header class="topbar">
    <div class="topbar-left">
      <button class="hamburger" type="button" (click)="toggleMenu()">
        <span></span><span></span><span></span>
      </button>
      <div class="logo">
        <img src="assets/HelloWorld-Logo.png" alt="HelloWorld Logo" />
      </div>
    </div>

    <div class="search">
      <input
        type="text"
        placeholder="Search posts, people, tags..."
        [(ngModel)]="searchTerm"
        (input)="onSearchInput()"
        (focus)="searchOpen = searchTerm.trim().length > 0"
        (keydown.escape)="clearSearch()"
      />

      @if (searchOpen) {
        <div class="search-dropdown">
          @if (searchResults$ | async; as results) {
            @if (results.people.length) {
              <div class="search-section">
                <div class="search-section-title">People</div>
                @for (user of results.people; track user.uid) {
                  <div class="search-item" (click)="goToUser(user.uid)">
                    <div class="search-avatar" [style.background]="user.avatarColor || '#0ea5a4'">
                      {{ getInitials(user.displayName) }}
                    </div>
                    <div class="search-info">
                      <div class="search-name">{{ user.displayName }}</div>
                      @if (user.role) {
                        <div class="search-sub">{{ user.role }}</div>
                      }
                    </div>
                  </div>
                }
              </div>
            }

            @if (results.posts.length) {
              <div class="search-section">
                <div class="search-section-title">Posts</div>
                @for (post of results.posts; track post.id) {
                  <div class="search-item" (click)="goToPost(post.id!)">
                    <div
                      class="search-avatar"
                      [style.background]="post.authorAvatarColor || '#0ea5a4'"
                    >
                      {{ getInitials(post.authorDisplayName || post.authorName) }}
                    </div>
                    <div class="search-info">
                      <div class="search-name">
                        {{ post.authorDisplayName || post.authorName || 'Anonymous' }}
                      </div>
                      <div class="search-sub search-excerpt">
                        {{ post.text | slice: 0 : 80 }}{{ post.text.length > 80 ? '...' : '' }}
                      </div>
                    </div>
                  </div>
                }
              </div>
            }

            @if (!results.people.length && !results.posts.length) {
              <div class="search-empty">No results for "{{ searchTerm }}"</div>
            }
          } @else {
            <div class="search-empty">Searching...</div>
          }
        </div>
      }
    </div>

    <div class="top-actions">
      <div #notifContainer>
        <button class="notif-bell" type="button" (click)="toggleNotifications()">
          üîî
          <ng-container *ngIf="unreadCount$ | async as c">
            <span *ngIf="c > 0" class="notif-badge">{{ c }}</span>
          </ng-container>
        </button>

        @if (notifOpen) {
          <div class="notif-panel">
            @for (n of (notifications$ | async) ?? []; track n.id) {
              <div
                class="notif-item"
                [class.unread]="!n.read"
                (click)="onNotificationClick(n)"
                style="cursor: pointer"
              >
                @if (n.type === 'like') {
                  <div>üëç {{ n.actorName || 'Someone' }} liked your post</div>
                }
                @if (n.type === 'comment') {
                  <div>üí¨ {{ n.actorName || 'Someone' }} commented on your post</div>
                }
                @if (n.type === 'follow') {
                  <div>üë§ {{ n.actorName || 'Someone' }} followed you</div>
                }
                @if (n.type === 'message') {
                  <div>üí¨ {{ n.actorName || 'Someone' }}: {{ n.preview || 'sent a message' }}</div>
                }
              </div>
            }
            @if (((notifications$ | async) ?? []).length === 0) {
              <div class="notif-empty">No notifications yet</div>
            }
          </div>
        }
      </div>
      <button
        class="avatar"
        type="button"
        routerLink="profile"
        routerLinkActive="active"
        [style.background]="avatarColor || '#0ea5a4'"
      >
        {{ getInitials(displayName) }}
      </button>
      <button class="signout" (click)="logout()">Sign out</button>
    </div>
  </header>

  <!-- Mobile slide-out drawer -->
  <div class="drawer-backdrop" [class.open]="menuOpen" (click)="toggleMenu()"></div>
  <aside class="drawer" [class.open]="menuOpen">
    <div class="drawer-header">
      <img src="assets/HelloWorld-Logo.png" alt="HelloWorld Logo" class="drawer-logo" />
      <button class="drawer-close" type="button" (click)="toggleMenu()">‚úï</button>
    </div>
    <nav class="drawer-nav">
      <a class="drawer-nav-item" routerLink="feed" routerLinkActive="active" (click)="toggleMenu()"
        >Home</a
      >
      <a
        class="drawer-nav-item"
        routerLink="discover"
        routerLinkActive="active"
        (click)="toggleMenu()"
        >Discover</a
      >
      <a
        class="drawer-nav-item"
        routerLink="following"
        routerLinkActive="active"
        (click)="toggleMenu()"
        >Following</a
      >
      <a
        class="drawer-nav-item"
        routerLink="messages"
        routerLinkActive="active"
        (click)="toggleMenu()"
        >Messages</a
      >
      <a
        class="drawer-nav-item"
        routerLink="profile"
        routerLinkActive="active"
        (click)="toggleMenu()"
        >Profile</a
      >
    </nav>
    <a class="drawer-signout" (click)="logout(); toggleMenu()">Sign out</a>
  </aside>

  <main class="main">
    <aside class="left">
      <div class="card">
        <div class="card-title">Navigation</div>
        <nav class="nav">
          <a class="nav-item active" routerLink="feed" routerLinkActive="active">Home</a>
          <a class="nav-item" routerLink="discover" routerLinkActive="active">Discover</a>
          <a class="nav-item" routerLink="following" routerLinkActive="active">Following</a>
          <a class="nav-item" routerLink="messages" routerLinkActive="active">Messages</a>
          <a class="nav-item" routerLink="profile" routerLinkActive="active">Profile</a>
        </nav>
      </div>
      <div class="right-inline">
        <app-chat-sidebar />
      </div>
    </aside>

    <section class="center">
      <div class="center-scroll">
        <router-outlet></router-outlet>
      </div>
    </section>

    <aside class="right">
      <app-chat-sidebar />
    </aside>
  </main>

  <!-- Fixed chat popup ‚Äî rendered outside the grid so position:fixed works freely -->
  <app-chat-popup />
</div>
