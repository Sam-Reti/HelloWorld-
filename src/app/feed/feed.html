<div class="feed-wrapper">
  <div class="hider">
    <div class="new-post">
      <textarea
        [(ngModel)]="text"
        placeholder="Post a question, share a win, or drop a snippet"
      ></textarea>

      <div class="composer-actions">
        <div class="hint">Use ``` for code blocks (beofre & after)</div>
        <button class="createpostbutton" (click)="createPost()" [disabled]="!text.trim()">
          Post
        </button>
      </div>
    </div>
  </div>

  @for (post of (posts$ | async) ?? []; track post.id) {
    <div class="post" [id]="'post-' + post.id">
      <div class="post-header">
        <div class="author">
          <div class="avatar">{{ getInitials(post.authorDisplayName || post.authorName) }}</div>

          <div class="meta">
            <div class="name">{{ post.authorDisplayName || post.authorName || 'Anonymous' }}</div>

            <div class="time">
              {{
                (post.createdAt?.toDate ? post.createdAt.toDate() : post.createdAt) | date: 'short'
              }}
            </div>
          </div>
        </div>
      </div>

      @if (editingPostId === post.id) {
        <div class="edit-post">
          <textarea [(ngModel)]="editText" class="edit-textarea"></textarea>
          <div class="edit-actions">
            <button class="edit-save" (click)="saveEdit(post.id!)" [disabled]="!editText.trim()">
              Save
            </button>
            <button class="edit-cancel" (click)="cancelEdit()">Cancel</button>
          </div>
        </div>
      } @else {
        <div class="post-text" [innerHTML]="renderMarkdown(post.text)"></div>
      }
      <div class="post-actions">
        <button class="action" [class.liked]="isLiked(post.id!)" (click)="toggleLike(post.id!)">
          üëç {{ post.likeCount || 0 }}
        </button>

        <button class="action" type="button" (click)="toggleComments(post.id!)">
          Comments ({{ post.commentCount || 0 }})
        </button>

        @if (post.authorId === currentUid) {
          <button class="action" type="button" (click)="startEdit(post)">Edit</button>
          <button class="action danger" type="button" (click)="delete(post.id!)">Delete</button>
        }
      </div>

      @if (showComments[post.id!]) {
        <div class="comments">
          <div class="comment-composer">
            <input [(ngModel)]="commentText[post.id!]" placeholder="Write a comment..." />
            <button class="send" type="button" (click)="submitComment(post.id!)">Send</button>
          </div>

          <div class="comment-list">
            @for (c of (getComments(post.id!) | async) ?? []; track c.id) {
              <div class="comment">
                <div class="comment-left">
                  <div class="comment-avatar">{{ (c.authorName || 'A')[0] }}</div>
                </div>

                <div class="comment-body">
                  <div class="comment-meta">
                    <strong>{{ c.authorName || 'Anonymous' }}</strong>
                    <span>
                      {{
                        (c.createdAt?.toDate ? c.createdAt.toDate() : c.createdAt) | date: 'short'
                      }}
                    </span>
                  </div>
                  <div class="comment-text">{{ c.text }}</div>
                </div>
              </div>
            }
          </div>
        </div>
      }
    </div>
  }
  @if (((posts$ | async) ?? []).length === 0) {
    <div class="empty-feed">
      <p>Your feed is empty.</p>
      <a routerLink="/app-home/discover">Find people to follow ‚Üí</a>
    </div>
  }
</div>
